<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodVisor - Food Safety Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'Inter', sans-serif;
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        body {
            --primary-color: #8B5CF6;
            --text-color: #E0E0E0;
            --hover-color: #A78BFA;
            --bg-blur: rgba(0, 0, 0, 0.7);
            --border-color: rgba(255, 255, 255, 0.3);
            background: #0B0B0B;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
        }

        body.light-mode {
            --primary-color: #8B5CF6;
            --text-color: #1A1A1A;
            --hover-color: #A78BFA;
            --bg-blur: rgba(255, 255, 255, 0.9);
            --border-color: #000000;
            background: #FFFFFF;
            color: var(--text-color);
        }

        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
        }

        /* Floating Icons */
        .floating-icons {
            position: fixed;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            z-index: 5;
            pointer-events: none;
        }

        .floating-icon {
            position: absolute;
            font-size: 30px;
            color: #666;
            filter: grayscale(100%) opacity(0.7);
            animation: float 15s infinite linear;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            pointer-events: auto;
            z-index: 6;
        }

        .floating-icon:hover {
            filter: grayscale(0%) opacity(1);
            color: var(--hover-color);
        }

        .floating-icon.apple { animation-duration: 20s; }
        .floating-icon.apple:hover { color: #FF5555; }
        .floating-icon.broccoli { animation-duration: 18s; animation-delay: -5s; }
        .floating-icon.broccoli:hover { color: #FFAA00; }
        .floating-icon.pill { animation-duration: 22s; animation-delay: -10s; }
        .floating-icon.pill:hover { color: #66B3FF; }
        .floating-icon.warning { animation-duration: 19s; animation-delay: -3s; }
        .floating-icon.warning:hover { color: #FF5555; }
        .floating-icon.heartbeat { animation-duration: 21s; animation-delay: -7s; }
        .floating-icon.heartbeat:hover { color: #FF69B4; }
        .floating-icon.lemon { animation-duration: 17s; animation-delay: -2s; }
        .floating-icon.lemon:hover { color: #FFFF00; }
        .floating-icon.utensils { animation-duration: 23s; animation-delay: -8s; }
        .floating-icon.utensils:hover { color: #FFAA00; }
        .floating-icon.shield { animation-duration: 16s; animation-delay: -4s; }
        .floating-icon.shield:hover { color: #0000FF; }

        @keyframes float {
            0% { transform: translate(0, 0); }
            20% { transform: translate(50px, 100px); }
            40% { transform: translate(-30px, 200px); }
            60% { transform: translate(70px, 300px); }
            80% { transform: translate(-50px, 100px); }
            100% { transform: translate(0, 0); }
        }

        /* Navigation Bar */
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--bg-blur);
            z-index: 10;
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }

        .light-mode .navbar {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .navbar.scrolled {
            background: rgba(0, 0, 0, 0.9);
        }

        .light-mode .navbar.scrolled {
            background: rgba(255, 255, 255, 1);
        }

        .nav-links {
            list-style: none;
            display: flex;
            gap: 20px;
            margin: 0;
            padding: 0;
            align-items: center;
        }

        .nav-links li a {
            color: var(--text-color);
            text-decoration: none;
            font-size: 1em;
            font-weight: 500;
            padding: 8px 15px;
            border-radius: 20px;
            transition: color 0.3s ease, background-color 0.3s ease;
        }

        .nav-links li a:hover {
            color: var(--hover-color);
            background-color: rgba(139, 92, 246, 0.1);
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .theme-toggle i {
            font-size: 20px;
            color: var(--primary-color);
            animation: bounce 2s infinite;
        }

        .light-mode .theme-toggle i {
            color: var(--text-color);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .hamburger {
            display: none;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: var(--primary-color);
            transition: transform 0.3s ease;
        }

        .light-mode .hamburger span {
            background: var(--text-color);
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 60px;
                width: 100%;
                background: var(--bg-blur);
                padding: 10px 0;
                backdrop-filter: blur(15px);
                border-bottom: 1px solid var(--border-color);
            }

            .nav-links.show {
                display: flex;
            }

            .nav-links li {
                text-align: center;
                padding: 10px 0;
            }

            .nav-links a {
                width: 100%;
                text-align: center;
                padding: 10px 15px;
            }

            .hamburger {
                display: flex;
                position: absolute;
                right: 20px;
            }

            .theme-toggle {
                margin-right: 60px;
            }
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex: 1;
            padding: 80px 20px 20px;
            position: relative;
            z-index: 1;
            gap: 20px;
            justify-content: center;
            min-height: 100vh;
        }

        .content-area {
            flex: 1;
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.2em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        body:not(.light-mode) .header h1 {
            text-shadow: 0 0 10px var(--primary-color);
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            0% { text-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color); }
            100% { text-shadow: 0 0 15px var(--primary-color), 0 0 30px var(--primary-color); }
        }

        .header p {
            font-size: 1.1em;
            color: #B0B0B0;
            margin-bottom: 20px;
        }

        /* Upload Card */
        .upload-card {
            background: var(--bg-blur);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), inset 0 0 10px rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }

        .upload-card:hover {
            transform: translateY(-5px);
        }

        .upload-card h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        body:not(.light-mode) .upload-card h2 {
            text-shadow: 0 0 10px var(--primary-color);
            animation: glow 2s infinite alternate;
        }

        .input-group {
            margin-bottom: 20px;
        }

        #imageAdjustments {
            background: var(--bg-blur);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 20px;
            max-width: 500px;
            margin: 20px auto;
            text-align: center;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), inset 0 0 10px rgba(255, 255, 255, 0.1);
        }

        #imageAdjustments h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        body:not(.light-mode) #imageAdjustments h2 {
            text-shadow: 0 0 10px var(--primary-color);
            animation: glow 2s infinite alternate;
        }

        #cropPreview {
            margin-top: 20px;
        }

        #cropImage {
            max-width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 10px;
        }

        .input-group label {
            display: block;
            font-size: 1em;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .input-group select,
        .input-group input {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            width: 100%;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .input-group select:focus,
        .input-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
            outline: none;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .cta-button {
            padding: 12px;
            background: var(--primary-color);
            border: none;
            border-radius: 10px;
            color: #121212;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        body:not(.light-mode) .cta-button {
            box-shadow: 0 0 10px var(--primary-color);
        }

        .cta-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.8);
        }

        .light-mode .cta-button {
            color: #FFFFFF;
        }

        .cta-button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Back Button */
        .back-button {
            position: absolute;
            top: 80px;
            left: 20px;
            padding: 10px 20px;
            background: var(--bg-blur);
            border: 2px solid var(--border-color);
            color: var(--primary-color);
            border-radius: 30px;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            backdrop-filter: blur(20px);
            animation: bounce 2s infinite;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        body:not(.light-mode) .back-button {
            text-shadow: 0 0 5px var(--primary-color);
        }

        .back-button:hover {
            background: rgba(139, 92, 246, 0.2);
            transform: scale(1.05);
        }

        /* Analysis Tabs */
        .analysis-tabs {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .tab {
            background: var(--bg-blur);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(20px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .tab:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.4);
        }

        .tab h2 {
            font-size: 1.5em;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        body:not(.light-mode) .tab h2 {
            text-shadow: 0 0 5px var(--primary-color);
            animation: glow 2s infinite alternate;
        }

        .score-tab {
            text-align: center;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(0, 0, 0, 0.7));
        }

        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: conic-gradient(
                #8B5CF6 0% calc(var(--score-percentage) * 1%),
                rgba(255, 255, 255, 0.1) calc(var(--score-percentage) * 1%) 100%
            );
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            position: relative;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg-blur);
        }

        .score-value {
            position: relative;
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .score-loading {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .concerns {
            background: rgba(255, 0, 0, 0.05);
            border-color: rgba(255, 0, 0, 0.2);
        }

        .likes {
            background: rgba(0, 255, 0, 0.05);
            border-color: rgba(0, 255, 0, 0.2);
        }

        .concern-item, .like-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .concern-item span, .like-item span {
            color: var(--text-color);
        }

        .recommendation {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 1em;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .additives-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .additive-badge {
            background: rgba(255, 0, 0, 0.3);
            color: #FF5555;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            position: relative;
            transition: transform 0.3s ease;
        }

        .additive-badge:hover {
            transform: scale(1.1);
        }

        .additive-badge:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            background: rgba(0, 0, 0, 0.8);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 5px;
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            white-space: nowrap;
            transition: opacity 0.3s ease;
        }

        .nutrients-table {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) rgba(255, 255, 255, 0.1);
        }

        .nutrients-table::-webkit-scrollbar {
            width: 8px;
        }

        .nutrients-table::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .nutrients-table::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
            box-shadow: 0 0 5px rgba(139, 92, 246, 0.5);
        }

        .nutrients-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .nutrients-table th, .nutrients-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .nutrients-table th {
            background: rgba(139, 92, 246, 0.1);
            color: var(--primary-color);
        }

        body:not(.light-mode) .nutrients-table th {
            text-shadow: 0 0 5px var(--primary-color);
        }

        .ingredients-list {
            margin-top: 10px;
            font-size: 1em;
            color: var(--text-color);
        }

        .ingredients-list p {
            margin-bottom: 10px;
        }

        .all-ingredients-section, .personalized-health-section, .special-codes-section, .special-codes-logs {
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid var(--border-color);
        }

        .all-ingredients-section h3, .personalized-health-section h3, .special-codes-section summary, .special-codes-logs h3 {
            font-size: 1.2em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        body:not(.light-mode) .all-ingredients-section h3,
        body:not(.light-mode) .personalized-health-section h3,
        body:not(.light-mode) .special-codes-section summary,
        body:not(.light-mode) .special-codes-logs h3 {
            text-shadow: 0 0 5px var(--primary-color);
        }

        .ingredient-safety-item, .personalized-health-item, .special-code-item {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .ingredient-safety-item:hover, .personalized-health-item:hover, .special-code-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        .ingredient-safety-item strong, .personalized-health-item strong, .special-code-item strong {
            color: var(--primary-color);
        }

        body:not(.light-mode) .ingredient-safety-item strong,
        body:not(.light-mode) .personalized-health-item strong,
        body:not(.light-mode) .special-code-item strong {
            text-shadow: 0 0 5px var(--primary-color);
        }

        details {
            cursor: pointer;
        }

        summary {
            padding: 5px;
        }

        .logs-content {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
            color: var(--text-color);
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
        }

        .logs-content pre {
            margin: 0;
            white-space: pre-wrap;
        }

        .product-details {
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .product-details h3 {
            font-size: 1.2em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        body:not(.light-mode) .product-details h3 {
            text-shadow: 0 0 5px var(--primary-color);
        }

        .product-details p {
            font-size: 1em;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .product-details strong {
            color: var(--primary-color);
        }

        body:not(.light-mode) .product-details strong {
            text-shadow: 0 0 5px var(--primary-color);
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--bg-blur);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(20px);
            display: none;
        }

        .sidebar img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
        }

        .sidebar h3 {
            font-size: 1.2em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        body:not(.light-mode) .sidebar h3 {
            text-shadow: 0 0 5px var(--primary-color);
        }

        .score-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .score-section h3 {
            font-size: 1.2em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        body:not(.light-mode) .score-section h3 {
            text-shadow: 0 0 5px var(--primary-color);
        }

        .score {
            font-size: 2em;
            font-weight: 700;
            color: var(--text-color);
        }

        .score-suffix {
            font-size: 0.8em;
            color: #B0B0B0;
        }

        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }

            .content-area {
                max-width: 100%;
            }
        }

        #webcamContainer {
            display: none;
            background: var(--bg-blur);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 20px;
            max-width: 500px;
            margin: 20px auto;
            text-align: center;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), inset 0 0 10px rgba(255, 255, 255, 0.1);
        }

        #webcamContainer h2 {
            font-size: 1.8em;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        body:not(.light-mode) #webcamContainer h2 {
            text-shadow: 0 0 10px var(--primary-color);
            animation: glow 2s infinite alternate;
        }

        #webcam {
            max-width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        #webcamControls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        #barcodeCanvas {
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="particleCanvas"></canvas>

    <!-- Floating Icons -->
    <div class="floating-icons">    
        <i class="fas fa-apple-alt floating-icon apple" style="top: 10%; left: 15%;"></i>
        <i class="fas fa-carrot floating-icon broccoli" style="top: 20%; left: 80%;"></i>
        <i class="fas fa-capsules floating-icon pill" style="top: 70%; left: 30%;"></i>
        <i class="fas fa-exclamation-triangle floating-icon warning" style="top: 50%; left: 60%;"></i>
        <i class="fas fa-heartbeat floating-icon heartbeat" style="top: 30%; left: 40%;"></i>
        <i class="fas fa-apple-alt floating-icon apple" style="top: 80%; left: 70%;"></i>
        <i class="fas fa-carrot floating-icon broccoli" style="top: 40%; left: 10%;"></i>
        <i class="fas fa-capsules floating-icon pill" style="top: 60%; left: 90%;"></i>
        <i class="fas fa-lemon floating-icon lemon" style="top: 15%; left: 50%;"></i>
        <i class="fas fa-utensils floating-icon utensils" style="top: 65%; left: 20%;"></i>
        <i class="fas fa-shield-alt floating-icon shield" style="top: 25%; left: 70%;"></i>
        <i class="fas fa-lemon floating-icon lemon" style="top: 75%; left: 40%;"></i>
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <ul class="nav-links">
            <li><a href="/">Home</a></li>
            <li><a href="/static/tellusaboutyou.html">Personalise</a></li>
            <li><a href="/static/askme.html">Chat</a></li>
            <li><a href="/static/calorietracker.html">Track Your Calories</a></li>
            <li><a href="/static/foodsafety.html">Food Safety</a></li>
            <li class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon"></i>
            </li>
        </ul>
        <div class="hamburger" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <div class="main-container">
        <div class="content-area">
            <div class="header">
                <h1>Food Safety Analysis</h1>
                <p>Analyze food labels, barcodes, or product names for detailed safety insights.</p>
                <button id="uploadButton" class="cta-button" style="display: none;">Upload Another</button>
                <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                <div id="imageAdjustments" style="display: none;">
                    <h2>Adjust Image</h2>
                    <div class="input-group">
                        <label for="brightness">Brightness: <span id="brightnessValue">0</span></label>
                        <input type="range" id="brightness" min="-100" max="100" value="0" oninput="updateBrightness(this.value)">
                    </div>
                    <div class="input-group">
                        <label for="contrast">Contrast: <span id="contrastValue">1</span></label>
                        <input type="range" id="contrast" min="0.1" max="3" step="0.1" value="1" oninput="updateContrast(this.value)">
                    </div>
                    <div class="input-group">
                        <label for="rotation">Rotation: <span id="rotationValue">0¬∞</span></label>
                        <input type="range" id="rotation" min="-180" max="180" value="0" oninput="updateRotation(this.value)">
                    </div>
                    <div class="input-group">
                        <label>Crop Image</label>
                        <button class="cta-button" onclick="startCropping()">Start Cropping</button>
                        <button class="cta-button" onclick="applyAdjustments()">Apply Adjustments</button>
                    </div>
                    <div id="cropPreview" style="display: none;">
                        <img id="cropImage" src="" alt="Crop Preview" style="max-width: 100%;">
                    </div>
                </div>
            </div>
            <div id="webcamContainer">
                <h2>Scan Barcode</h2>
                <video id="webcam" autoplay playsinline></video>
                <canvas id="barcodeCanvas"></canvas>
                <div id="webcamControls">
                    <button class="cta-button" onclick="startWebcam()">Start Webcam</button>
                    <button class="cta-button" onclick="captureImage()">Capture Image</button>
                    <button class="cta-button" onclick="stopWebcam()">Cancel</button>
                </div>
            </div>

            <div id="uploadPrompt" class="upload-card">
                <h2>Analyze Your Food</h2>
                <div class="input-group">
                    <label for="modelSelect">Select Analysis Model</label>
                    <select id="modelSelect">
                        <option value="pro">Pro Model (H + G + RAG)</option>
                        <option value="base">Base Model (G + RAG)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Upload/scan food label or barcode</label>
                    <div class="button-group">
                        <button class="cta-button" onclick="document.getElementById('imageInput').click()">Upload Label</button>
                        <button class="cta-button" onclick="document.getElementById('barcodeInput').click()">Upload Barcode</button>
                        <button class="cta-button" onclick="showWebcam()">Scan Barcode</button>
                    </div>
                </div>
                <div class="input-group">
                    <label for="foodInput">Or Enter Food Name</label>
                    <input type="text" id="foodInput" placeholder="e.g., Apple Pie">
                    <button class="cta-button" onclick="analyzeFoodName()">Analyze Food</button>
                </div>
                <input type="file" id="barcodeInput" accept="image/*" style="display: none;" onchange="handleBarcodeUpload(event)">
            </div>

            <div id="analysisTabs" class="analysis-tabs" style="display: none;">
                <button class="back-button" onclick="goBack()">Back</button>
                <div id="scoreTab" class="tab score-tab">
                    <h2>üåü Product Score</h2>
                    <div id="scoreCircle" class="score-circle">
                        <span id="scoreValue" class="score-value">...</span>
                    </div>
                    <div id="scoreMessage"></div>
                </div>
                <div id="concernsTab" class="tab concerns">
                    <h2>üìç What Concerns Us</h2>
                    <div id="concernsContent"></div>
                </div>
                <div id="likesTab" class="tab likes">
                    <h2>üíö What We Like</h2>
                    <div id="likesContent"></div>
                </div>
                <div id="nutrientsTab" class="tab">
                    <h2>üìä All Nutrients</h2>
                    <div id="nutrientsContent" class="nutrients-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nutrient</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="nutrientsTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div id="ingredientsTab" class="tab">
                    <h2>üßæ All Ingredients</h2>
                    <div id="ingredientsContent" class="ingredients-list"></div>
                </div>
                <div id="all-ingredients-tab" class="tab">
                    <h2>All Ingredients Breakdown</h2>
                    <div id="all-ingredients-list"></div>
                    <h3>Special Codes</h3>
                    <div id="special-codes-list"></div>
                </div>
            </div>
        </div>

        <div id="sidebar" class="sidebar">
            <h3>Label Preview</h3>
            <img id="labelPreview" src="" alt="Label Preview">
            <div id="scoreSection" class="score-section">
                <h3>Product Score</h3>
                <div id="productScore" class="score">...</div>
                <span class="score-suffix">/ 10</span>
            </div>
        </div>
    </div>

    <script>
        let messages = [];
        let currentController = null;
        let userAllergies = '';
        let userMedicalInfo = '';

        // Fetch user details on page load
        window.onload = async function() {
            // Fetch user details for allergies and medical info
            try {
                const response = await fetch('/user/details');
                const data = await response.json();
                if (data.success) {
                    userAllergies = data.allergies || '';
                    userMedicalInfo = data.medical_info || '';
                }
            } catch (error) {
                console.error('Error fetching user details:', error);
            }

            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                displayAnalysis(
                    lastMessage.foodsafetyAnalysis,
                    lastMessage.ingredientSafetyAssessments,
                    lastMessage.specialCodesWithDetails,
                    lastMessage.specialCodeLogs,
                    lastMessage.concernsAndLikes
                );
                fetchProductScore(lastMessage);
            }
        };

        function toggleMenu() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('show');
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const themeIcon = document.querySelector('.theme-toggle i');
            if (document.body.classList.contains('light-mode')) {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }

        function showAnalysisUI() {
            document.getElementById('uploadPrompt').style.display = 'none';
            document.getElementById('analysisTabs').style.display = 'flex';
            document.getElementById('uploadButton').style.display = 'block';
        }

        function goBack() {
            document.getElementById('uploadPrompt').style.display = 'block';
            document.getElementById('imageAdjustments').style.display = 'none';
            document.getElementById('webcamContainer').style.display = 'none';
            document.getElementById('analysisTabs').style.display = 'none';
            document.getElementById('uploadButton').style.display = 'none';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('foodInput').value = '';
            document.getElementById('brightness').value = 0;
            document.getElementById('contrast').value = 1;
            document.getElementById('rotation').value = 0;
            document.getElementById('brightnessValue').innerText = '0';
            document.getElementById('contrastValue').innerText = '1';
            document.getElementById('rotationValue').innerText = '0¬∞';
            document.getElementById('cropPreview').style.display = 'none';
            document.getElementById('scoreValue').innerText = '...';
            document.getElementById('productScore').innerText = '...';
            document.getElementById('scoreMessage').innerText = '';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            stopWebcam();
        }

        let currentImageSrc = null;
        let cropper = null;

        // Debounce function to limit AJAX calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Function to update image preview in real-time
        const updateImagePreview = debounce(function() {
            if (!currentImageSrc) return;
            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            const rotation = document.getElementById('rotation').value;
            let cropData = null;
            if (cropper) {
                const cropBox = cropper.getCropBoxData();
                cropData = {
                    x: Math.round(cropBox.left),
                    y: Math.round(cropBox.top),
                    width: Math.round(cropBox.width),
                    height: Math.round(cropBox.height)
                };
            }

            fetch('/processImageAdjustments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    imageSrc: currentImageSrc,
                    brightness: brightness,
                    contrast: contrast,
                    rotation: rotation,
                    crop: cropData,
                    preview: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('labelPreview').src = data.adjusted_image;
                    document.getElementById('cropImage').src = data.adjusted_image;
                } else {
                    console.error('Preview error:', data.error);
                }
            })
            .catch(error => console.error('Fetch error:', error));
        }, 300);

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageSrc = e.target.result;
                document.getElementById('uploadPrompt').style.display = 'none';
                document.getElementById('imageAdjustments').style.display = 'block';
                document.getElementById('sidebar').style.display = 'block';
                document.getElementById('labelPreview').src = currentImageSrc;

                // Reset adjustment controls
                document.getElementById('brightness').value = 0;
                document.getElementById('contrast').value = 1;
                document.getElementById('rotation').value = 0;
                document.getElementById('brightnessValue').innerText = '0';
                document.getElementById('contrastValue').innerText = '1';
                document.getElementById('rotationValue').innerText = '0¬∞';
                document.getElementById('cropPreview').style.display = 'none';
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            };
            reader.readAsDataURL(file);
        }

        function updateBrightness(value) {
            document.getElementById('brightnessValue').innerText = value;
            updateImagePreview();
        }

        function updateContrast(value) {
            document.getElementById('contrastValue').innerText = value;
            updateImagePreview();
        }

        function updateRotation(value) {
            document.getElementById('rotationValue').innerText = `${value}¬∞`;
            updateImagePreview();
        }

        function startCropping() {
            document.getElementById('cropPreview').style.display = 'block';
            document.getElementById('cropImage').src = currentImageSrc;
            if (cropper) {
                cropper.destroy();
            }
            cropper = new Cropper(document.getElementById('cropImage'), {
                aspectRatio: NaN,
                viewMode: 1,
                autoCropArea: 0.8,
                movable: true,
                zoomable: true,
                scalable: true,
                crop: function(event) {
                    updateImagePreview();
                }
            });
        }

        function applyAdjustments() {
            if (currentController) {
                currentController.abort();
            }
            currentController = new AbortController();
            const signal = currentController.signal;

            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            const rotation = document.getElementById('rotation').value;
            const modelType = document.getElementById('modelSelect').value;
            let cropData = null;
            if (cropper) {
                cropData = cropper.getCropBoxData();
                cropData = {
                    x: Math.round(cropData.left),
                    y: Math.round(cropData.top),
                    width: Math.round(cropData.width),
                    height: Math.round(cropData.height)
                };
                cropper.destroy();
                cropper = null;
            }

            fetch('/processImageAdjustments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    imageSrc: currentImageSrc,
                    brightness: brightness,
                    contrast: contrast,
                    rotation: rotation,
                    crop: cropData,
                    preview: false
                }),
                signal
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('imageAdjustments').style.display = 'none';
                    document.getElementById('analysisTabs').style.display = 'flex';
                    document.getElementById('uploadButton').style.display = 'block';
                    document.getElementById('sidebar').style.display = 'block';
                    document.getElementById('labelPreview').src = data.adjusted_image;

                    fetch('/foodsafety', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ingredients: data.extracted_text,
                            model_type: modelType
                        }),
                        signal
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const foodsafetyAnalysis = data.foodsafety_analysis || {};
                            const ingredientSafetyAssessments = data.ingredient_safety_assessments || [];
                            const specialCodesWithDetails = data.special_codes_with_details || [];
                            const specialCodeLogs = data.special_code_logs || [];
                            const concernsAndLikes = data.concerns_and_likes || { concerns: [], likes: [], recommendation: '' };
                            messages.push({
                                type: 'foodsafety',
                                imageSrc: currentImageSrc,
                                ingredients_FS: data.extracted_text,
                                foodsafetyAnalysis: foodsafetyAnalysis,
                                ingredientSafetyAssessments: ingredientSafetyAssessments,
                                specialCodesWithDetails: specialCodesWithDetails,
                                specialCodeLogs: specialCodeLogs,
                                concernsAndLikes: concernsAndLikes
                            });
                            displayAnalysis(foodsafetyAnalysis, ingredientSafetyAssessments, specialCodesWithDetails, specialCodeLogs, concernsAndLikes);
                            fetchProductScore(messages[messages.length - 1]);
                        } else {
                            alert('Error: Could not analyze ingredients.');
                        }
                        currentController = null;
                    })
                    .catch(error => {
                        if (error.name === 'AbortError') {
                            console.log('Previous request aborted');
                        } else {
                            console.error('Error:', error);
                            alert('Error: Could not connect to the server.');
                        }
                        currentController = null;
                    });
                } else {
                    alert('Error: Could not process image adjustments.');
                    currentController = null;
                }
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    console.log('Previous request aborted');
                } else {
                    console.error('Error:', error);
                    alert('Error: Could not connect to the server.');
                }
                currentController = null;
            });
        }

        function analyzeFoodName() {
            const foodName = document.getElementById('foodInput').value.trim();
            const modelType = document.getElementById('modelSelect').value;
            if (!foodName) {
                alert('Please enter a food name.');
                return;
            }

            const button = document.querySelector('button[onclick="analyzeFoodName()"]');
            button.disabled = true;
            setTimeout(() => { button.disabled = false; }, 5000);

            if (currentController) {
                currentController.abort();
            }

            currentController = new AbortController();
            const signal = currentController.signal;

            showAnalysisUI();
            document.getElementById('sidebar').style.display = 'none';

            fetch('/geminiAnalyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    foodName: foodName, 
                    servingSize: '100g',
                    modelType: modelType
                }),
                signal
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const foodsafetyAnalysis = data.foodsafety_analysis || {};
                    const ingredientSafetyAssessments = data.ingredient_safety_assessments || [];
                    const specialCodesWithDetails = data.special_codes_with_details || [];
                    const specialCodeLogs = data.special_code_logs || [];
                    const concernsAndLikes = data.concerns_and_likes || { concerns: [], likes: [], recommendation: '' };
                    messages.push({
                        type: 'foodsafety',
                        foodName: foodName,
                        ingredients_FS: foodsafetyAnalysis.ingredients || '',
                        foodsafetyAnalysis: foodsafetyAnalysis,
                        ingredientSafetyAssessments: ingredientSafetyAssessments,
                        specialCodesWithDetails: specialCodesWithDetails,
                        specialCodeLogs: specialCodeLogs,
                        concernsAndLikes: concernsAndLikes
                    });
                    displayAnalysis(foodsafetyAnalysis, ingredientSafetyAssessments, specialCodesWithDetails, specialCodeLogs, concernsAndLikes);
                    fetchProductScore(messages[messages.length - 1]);
                } else {
                    alert('Error: Could not analyze food.');
                }
                currentController = null;
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    console.log('Previous request aborted');
                } else {
                    console.error('Error:', error);
                    alert('Error: Could not connect to the server.');
                }
                currentController = null;
            });
        }

        function handleBarcodeUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const modelType = document.getElementById('modelSelect').value;

            const reader = new FileReader();
            reader.onload = function(e) {
                const barcodeImage = e.target.result;

                showAnalysisUI();
                document.getElementById('sidebar').style.display = 'block';
                document.getElementById('labelPreview').src = barcodeImage;

                if (currentController) {
                    currentController.abort();
                }

                currentController = new AbortController();
                const signal = currentController.signal;

                fetch('/processBarcode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        barcodeImage: barcodeImage,
                        model_type: modelType
                    }),
                    signal
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const foodsafetyAnalysis = data.foodsafety_analysis || {};
                        const ingredientSafetyAssessments = data.ingredient_safety_assessments || [];
                        const specialCodesWithDetails = data.special_codes_with_details || [];
                        const specialCodeLogs = data.special_code_logs || [];
                        const concernsAndLikes = data.concerns_and_likes || { concerns: [], likes: [], recommendation: '' };
                        messages.push({
                            type: 'foodsafety',
                            barcode: data.barcode,
                            product_name: data.product_details.product_name,
                            brand: data.product_details.brand,
                            quantity: data.product_details.quantity,
                            country: data.product_details.country,
                            ingredients_FS: foodsafetyAnalysis.ingredients || '',
                            foodsafetyAnalysis: foodsafetyAnalysis,
                            ingredientSafetyAssessments: ingredientSafetyAssessments,
                            specialCodesWithDetails: specialCodesWithDetails,
                            specialCodeLogs: specialCodeLogs,
                            concernsAndLikes: concernsAndLikes
                        });
                        displayAnalysis(foodsafetyAnalysis, ingredientSafetyAssessments, specialCodesWithDetails, specialCodeLogs, concernsAndLikes);
                        fetchProductScore(messages[messages.length - 1]);
                    } else {
                        alert('Error: ' + data.error);
                    }
                    currentController = null;
                })
                .catch(error => {
                    if (error.name === 'AbortError') {
                        console.log('Previous request aborted');
                    } else {
                        console.error('Error:', error);
                        alert('Error: Could not connect to the server.');
                    }
                    currentController = null;
                });
            };
            reader.readAsDataURL(file);
        }

        let videoStream = null;

        function showWebcam() {
            document.getElementById('uploadPrompt').style.display = 'none';
            document.getElementById('imageAdjustments').style.display = 'none';
            document.getElementById('webcamContainer').style.display = 'block';
            document.getElementById('sidebar').style.display = 'none';
        }

        function startWebcam() {
            const video = document.getElementById('webcam');
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(function(stream) {
                        videoStream = stream;
                        video.srcObject = stream;
                        video.play();
                    })
                    .catch(function(err) {
                        console.error('Error accessing webcam:', err);
                        alert('Error accessing webcam: ' + err.message);
                    });
            } else {
                alert('Webcam access is not supported by this browser.');
            }
        }

        function captureImage() {
            const video = document.getElementById('webcam');
            const canvas = document.getElementById('barcodeCanvas');
            const canvasContext = canvas.getContext('2d');
            const modelType = document.getElementById('modelSelect').value;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
            const barcodeImage = canvas.toDataURL('image/jpeg');

            stopWebcam();
            showAnalysisUI();
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('labelPreview').src = barcodeImage;

            if (currentController) {
                currentController.abort();
            }
            currentController = new AbortController();
            const signal = currentController.signal;

            fetch('/processBarcode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    barcodeImage: barcodeImage,
                    model_type: modelType
                }),
                signal
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const foodsafetyAnalysis = data.foodsafety_analysis || {};
                    const ingredientSafetyAssessments = data.ingredient_safety_assessments || [];
                    const specialCodesWithDetails = data.special_codes_with_details || [];
                    const specialCodeLogs = data.special_code_logs || [];
                    const concernsAndLikes = data.concerns_and_likes || { concerns: [], likes: [], recommendation: '' };
                    messages.push({
                        type: 'foodsafety',
                        barcode: data.barcode,
                        product_name: data.product_details.product_name,
                        brand: data.product_details.brand,
                        quantity: data.product_details.quantity,
                        country: data.product_details.country,
                        ingredients_FS: foodsafetyAnalysis.ingredients || '',
                        foodsafetyAnalysis: foodsafetyAnalysis,
                        ingredientSafetyAssessments: ingredientSafetyAssessments,
                        specialCodesWithDetails: specialCodesWithDetails,
                        specialCodeLogs: specialCodeLogs,
                        concernsAndLikes: concernsAndLikes
                    });
                    displayAnalysis(foodsafetyAnalysis, ingredientSafetyAssessments, specialCodesWithDetails, specialCodeLogs, concernsAndLikes);
                    fetchProductScore(messages[messages.length - 1]);
                } else {
                    alert('Error: ' + data.error);
                }
                currentController = null;
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    console.log('Previous request aborted');
                } else {
                    console.error('Error:', error);
                    alert('Error: Could not connect to the server.');
                }
                currentController = null;
            });
        }

        function stopWebcam() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                document.getElementById('webcam').srcObject = null;
            }
            document.getElementById('webcamContainer').style.display = 'none';
            document.getElementById('uploadPrompt').style.display = 'block';
        }

        async function fetchProductScore(message) {
            const { foodsafetyAnalysis, ingredientSafetyAssessments, concernsAndLikes } = message;

            // Show loading state
            const scoreValue = document.getElementById('scoreValue');
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreMessage = document.getElementById('scoreMessage');
            const sidebarScore = document.getElementById('productScore');
            
            scoreValue.classList.add('score-loading');
            scoreValue.innerText = '...';
            scoreCircle.style.setProperty('--score-percentage', '0');
            scoreMessage.innerText = 'Calculating score...';
            sidebarScore.innerText = '...';

            try {
                // Prepare foodsafetyAnalysis object
                const formattedFoodsafetyAnalysis = {
                    processing_level: foodsafetyAnalysis.processing_level || 'N/A',
                    hydrogenated_oil: foodsafetyAnalysis.hydrogenated_oil || 'Not Present',
                    additives: foodsafetyAnalysis.additives || [],
                    energy: foodsafetyAnalysis.energy || 'N/A',
                    total_sugars: foodsafetyAnalysis.total_sugars || 'N/A',
                    total_fat: foodsafetyAnalysis.total_fat || 'N/A',
                    saturated_fat: foodsafetyAnalysis.saturated_fat || 'N/A',
                    trans_fat: foodsafetyAnalysis.trans_fat || 'N/A',
                    cholesterol: foodsafetyAnalysis.cholesterol || 'N/A',
                    sodium: foodsafetyAnalysis.sodium || 'N/A',
                    nutrients: foodsafetyAnalysis.nutrients || [],
                    ingredients: foodsafetyAnalysis.ingredients || ''
                };

                // Prepare concernsAndLikes object
                const formattedConcernsAndLikes = {
                    concerns: concernsAndLikes.concerns || [],
                    likes: concernsAndLikes.likes || [],
                    recommendation: concernsAndLikes.recommendation || ''
                };

                // Prepare specialCodesWithDetails
                const formattedSpecialCodes = ingredientSafetyAssessments
                    .filter(assessment => assessment.ingredient && assessment.ingredient.match(/\(\d+\)/))
                    .map(assessment => ({
                        additive: assessment.ingredient.match(/\((\d+)\)/)?.[1] || assessment.ingredient,
                        personalized_health_assessment: assessment.personalized_health_assessment || ''
                    }));

                // Prepare the payload for /geminiScore
                const scoreData = {
                    foodsafetyAnalysis: formattedFoodsafetyAnalysis,
                    concernsAndLikes: formattedConcernsAndLikes,
                    allergies: userAllergies,
                    medicalInfo: userMedicalInfo,
                    specialCodesWithDetails: formattedSpecialCodes
                };

                if (currentController) {
                    currentController.abort();
                }
                currentController = new AbortController();
                const signal = currentController.signal;

                const response = await fetch('/geminiScore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scoreData),
                    signal
                });

                const data = await response.json();

                if (data.success && data.score !== undefined) {
                    const score = Math.round(data.score / 10); // Convert 0-100 score to 0-10
                    scoreValue.classList.remove('score-loading');
                    scoreValue.innerText = score;
                    sidebarScore.innerText = score;
                    scoreCircle.style.setProperty('--score-percentage', data.score);

                    // Add a message based on the score
                    let messageText = '';
                    if (data.score >= 80) {
                        messageText = 'Excellent choice! This product is very safe.';
                    } else if (data.score >= 60) {
                        messageText = 'Good product, but check the concerns.';
                    } else if (data.score >= 40) {
                        messageText = 'Moderate safety. Review concerns carefully.';
                    } else {
                        messageText = 'Caution: This product has significant concerns.';
                    }
                    scoreMessage.innerText = messageText;
                } else {
                    throw new Error(data.error || 'Failed to fetch score');
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    scoreValue.classList.remove('score-loading');
                    scoreValue.innerText = 'N/A';
                    sidebarScore.innerText = 'N/A';
                    scoreCircle.style.setProperty('--score-percentage', '0');
                    scoreMessage.innerText = 'Unable to calculate score';
                    console.error('Scoring error:', error);
                }
            } finally {
                currentController = null;
            }
        }

        function displayAnalysis(foodsafetyAnalysis, ingredientSafetyAssessments, specialCodesWithDetails, specialCodeLogs, concernsAndLikes) {
            const concernsContent = document.getElementById('concernsContent');
            const likesContent = document.getElementById('likesContent');
            const nutrientsTableBody = document.getElementById('nutrientsTableBody');
            const ingredientsContent = document.getElementById('ingredientsContent');
            const allIngredientsList = document.getElementById('all-ingredients-list');
            const specialCodesList = document.getElementById('special-codes-list');

            // Clear previous content
            concernsContent.innerHTML = '';
            likesContent.innerHTML = '';
            nutrientsTableBody.innerHTML = '';
            ingredientsContent.innerHTML = '';
            allIngredientsList.innerHTML = '';
            specialCodesList.innerHTML = '';

            // Display Product Details
            if (messages[messages.length - 1].product_name) {
                const productDetails = document.createElement('div');
                productDetails.className = 'product-details';
                let detailsHTML = '<h3>Product Details</h3>';
                const fields = [
                    { key: 'product_name', label: 'Name' },
                    { key: 'brand', label: 'Brand' },
                    { key: 'quantity', label: 'Quantity' },
                    { key: 'country', label: 'Country' }
                ];
                fields.forEach(field => {
                    const value = messages[messages.length - 1][field.key];
                    if (value && value !== 'N/A' && value !== '') {
                        detailsHTML += `<p><strong>${field.label}:</strong> ${value}</p>`;
                    }
                });
                if (detailsHTML !== '<h3>Product Details</h3>') {
                    productDetails.innerHTML = detailsHTML;
                    ingredientsContent.appendChild(productDetails);
                }
            }

            // Display "What Concerns Us"
            if (concernsAndLikes.concerns && concernsAndLikes.concerns.length > 0) {
                concernsAndLikes.concerns.forEach(item => {
                    if (item.value && item.value !== 'N/A' && item.value !== '') {
                        const concernItem = document.createElement('div');
                        concernItem.className = 'concern-item';
                        concernItem.innerHTML = `
                            <span>‚ö†Ô∏è ${item.label}: ${item.value}</span>
                        `;
                        concernsContent.appendChild(concernItem);
                    }
                });
            } else {
                concernsContent.innerHTML = '<p>No concerns identified.</p>';
            }

            // Display Recommendation
            if (concernsAndLikes.recommendation && concernsAndLikes.recommendation !== 'N/A' && concernsAndLikes.recommendation !== '') {
                const recommendationDiv = document.createElement('div');
                recommendationDiv.className = 'recommendation';
                recommendationDiv.innerHTML = `<strong>Recommendation:</strong> ${concernsAndLikes.recommendation}`;
                concernsContent.appendChild(recommendationDiv);
            }

            // Display "What We Like"
            if (concernsAndLikes.likes && concernsAndLikes.likes.length > 0) {
                concernsAndLikes.likes.forEach(item => {
                    if (item.value && item.value !== 'N/A' && item.value !== '') {
                        const likeItem = document.createElement('div');
                        likeItem.className = 'like-item';
                        likeItem.innerHTML = `
                            <span>‚úÖ ${item.label}: ${item.value}</span>
                        `;
                        likesContent.appendChild(likeItem);
                    }
                });
            } else {
                likesContent.innerHTML = '<p>No positive aspects identified.</p>';
            }

            // Display Processing Level
            if (foodsafetyAnalysis.processing_level && foodsafetyAnalysis.processing_level !== 'N/A' && foodsafetyAnalysis.processing_level !== '') {
                const processingItem = document.createElement('div');
                processingItem.className = 'concern-item';
                processingItem.innerHTML = `
                    <span>‚ö†Ô∏è Processing Level: ${foodsafetyAnalysis.processing_level}</span>
                `;
                concernsContent.insertBefore(processingItem, concernsContent.firstChild);
            }

            // Display Hydrogenated Oil
            if (foodsafetyAnalysis.hydrogenated_oil && foodsafetyAnalysis.hydrogenated_oil !== 'N/A' && foodsafetyAnalysis.hydrogenated_oil !== '') {
                const hydroItem = document.createElement('div');
                hydroItem.className = foodsafetyAnalysis.hydrogenated_oil.toLowerCase() === 'present' ? 'concern-item' : 'like-item';
                hydroItem.innerHTML = `
                    <span>${foodsafetyAnalysis.hydrogenated_oil.toLowerCase() === 'present' ? '‚ö†Ô∏è' : '‚úÖ'} Hydrogenated Vegetable Oil: ${foodsafetyAnalysis.hydrogenated_oil}</span>
                `;
                if (foodsafetyAnalysis.hydrogenated_oil.toLowerCase() === 'present') {
                    concernsContent.appendChild(hydroItem);
                } else {
                    likesContent.appendChild(hydroItem);
                }
            }

            // Display Additives
            if (foodsafetyAnalysis.additives && foodsafetyAnalysis.additives.length > 0) {
                const additivesList = document.createElement('div');
                additivesList.className = 'additives-list';
                foodsafetyAnalysis.additives.forEach(additive => {
                    if (additive.name && additive.name !== 'N/A' && additive.name !== '') {
                        const badge = document.createElement('span');
                        badge.className = 'additive-badge';
                        badge.innerText = additive.name;
                        if (additive.description && additive.description !== 'N/A' && additive.description !== '') {
                            const tooltip = document.createElement('span');
                            tooltip.className = 'tooltip';
                            tooltip.innerText = additive.description;
                            badge.appendChild(tooltip);
                        }
                        additivesList.appendChild(badge);
                    }
                });
                if (additivesList.children.length > 0) {
                    const additivesDiv = document.createElement('div');
                    additivesDiv.className = 'concern-item';
                    additivesDiv.innerHTML = '<span>üß™ Additives:</span>';
                    additivesDiv.appendChild(additivesList);
                    concernsContent.appendChild(additivesDiv);
                }
            }

            // Display Nutrients
            const nutrientFields = [
                { key: 'energy', label: 'Energy' },
                { key: 'total_sugars', label: 'Total Sugars' },
                { key: 'total_fat', label: 'Total Fat' },
                { key: 'saturated_fat', label: 'Saturated Fat' },
                { key: 'trans_fat', label: 'Trans Fat' },
                { key: 'cholesterol', label: 'Cholesterol' },
                { key: 'sodium', label: 'Sodium' }
            ];

            nutrientFields.forEach(field => {
                if (foodsafetyAnalysis[field.key] && foodsafetyAnalysis[field.key] !== 'N/A' && foodsafetyAnalysis[field.key] !== '') {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${field.label}</td>
                        <td>${foodsafetyAnalysis[field.key]}</td>
                    `;
                    nutrientsTableBody.appendChild(row);
                }
            });

            if (foodsafetyAnalysis.nutrients && foodsafetyAnalysis.nutrients.length > 0) {
                foodsafetyAnalysis.nutrients.forEach(nutrient => {
                    if (nutrient.name && nutrient.amount && nutrient.amount !== 'N/A' && nutrient.amount !== '') {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${nutrient.name}</td>
                            <td>${nutrient.amount}</td>
                        `;
                        nutrientsTableBody.appendChild(row);
                    }
                });
            }

            // Display Ingredients
            if (foodsafetyAnalysis.ingredients && foodsafetyAnalysis.ingredients !== 'N/A' && foodsafetyAnalysis.ingredients !== '') {
                const ingredientsP = document.createElement('p');
                ingredientsP.innerText = `Ingredients: ${foodsafetyAnalysis.ingredients}`;
                ingredientsContent.appendChild(ingredientsP);
            }

            // Populate All Ingredients List
            if (ingredientSafetyAssessments && ingredientSafetyAssessments.length > 0) {
                ingredientSafetyAssessments.forEach(assessment => {
                    if (assessment.ingredient && assessment.ingredient !== 'N/A' && assessment.ingredient !== '') {
                        const div = document.createElement('div');
                        div.className = 'ingredient-safety-item';
                        div.innerHTML = `
                            <p><strong>${assessment.ingredient}</strong></p>
                            ${assessment.safety_assessment && assessment.safety_assessment !== 'N/A' ? `<p><em>Safety Assessment:</em> ${assessment.safety_assessment}</p>` : ''}
                            ${assessment.personalized_health_assessment && assessment.personalized_health_assessment !== 'N/A' ? `<p><em>Personalized Health Assessment:</em> ${assessment.personalized_health_assessment}</p>` : ''}
                        `;
                        allIngredientsList.appendChild(div);
                    }
                });
            } else {
                allIngredientsList.innerHTML = '<p>No ingredient safety assessments available.</p>';
            }

            // Populate Special Codes List
            if (specialCodesWithDetails && specialCodesWithDetails.length > 0) {
                specialCodesWithDetails.forEach(code => {
                    if (code.additive && code.additive !== 'N/A' && code.additive !== '') {
                        const div = document.createElement('div');
                        div.className = 'special-code-item';
                        div.innerHTML = `
                            <p><strong>${code.additive}</strong></p>
                            ${code.personalized_health_assessment && code.personalized_health_assessment !== 'N/A' ? `<p><em>Personalized Health Assessment:</em> ${code.personalized_health_assessment}</p>` : ''}
                        `;
                        specialCodesList.appendChild(div);
                    }
                });
            } else {
                specialCodesList.innerHTML = '<p>No special codes identified.</p>';
            }

            // Display Special Code Logs
            if (specialCodeLogs && specialCodeLogs.length > 0 && specialCodeLogs.some(log => log && log !== 'N/A' && log !== '')) {
                const logsSection = document.createElement('div');
                logsSection.className = 'special-codes-logs';
                logsSection.innerHTML = `
                    <h3>Special Code Logs</h3>
                    <div class="logs-content">
                        <pre>${specialCodeLogs.join('')}</pre>
                    </div>
                `;
                ingredientsContent.appendChild(logsSection);
            }
        }

        // Particle Background Animation
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        let particlesArray = [];

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 5 + 1;
                this.speedX = Math.random() * 1 - 0.5;
                this.speedY = Math.random() * 1 - 0.5;
                this.color = `rgba(139, 92, 246, ${Math.random() * 0.5 + 0.2})`;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;

                if (this.size > 0.2) this.size -= 0.01;

                if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particlesArray = [];
            const numberOfParticles = (canvas.width * canvas.height) / 9000;
            for (let i = 0; i < numberOfParticles; i++) {
                particlesArray.push(new Particle());
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < particlesArray.length; i++) {
                particlesArray[i].update();
                particlesArray[i].draw();

                for (let j = i + 1; j < particlesArray.length; j++) {
                    const dx = particlesArray[i].x - particlesArray[j].x;
                    const dy = particlesArray[i].y - particlesArray[j].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 100) {
                        ctx.strokeStyle = `rgba(139, 92, 246, ${1 - distance / 100})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(particlesArray[i].x, particlesArray[i].y);
                        ctx.lineTo(particlesArray[j].x, particlesArray[j].y);
                        ctx.stroke();
                    }
                }

                if (particlesArray[i].size <= 0.2) {
                    particlesArray.splice(i, 1);
                    i--;
                    particlesArray.push(new Particle());
                }
            }
            requestAnimationFrame(animateParticles);
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initParticles();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        initParticles();
        animateParticles();
    </script>
</body>
</html>