<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodVisor - Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;200;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
            font-weight: 200;
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        body {
            --primary-color: #8B5CF6;
            --text-color: #E0E0E0;
            --hover-color: #A78BFA;
            --bg-blur: rgba(0, 0, 0, 0.7);
            --border-color: rgba(255, 255, 255, 0.3);
            background: #0B0B0B;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        body.light-mode {
            --primary-color: #8B5CF6;
            --text-color: #1A1A1A;
            --hover-color: #A78BFA;
            --bg-blur: rgba(255, 255, 255, 0.9);
            --border-color: #000000;
            background: #FFFFFF;
            color: var(--text-color);
        }

        /* Floating Icons */
        .floating-icons {
            position: fixed;
            width: 100%;
            height: 100vh;
            overflow: visible;
            z-index: 5;
            pointer-events: none;
        }

        .floating-icon {
            position: absolute;
            font-size: 30px;
            color: #666;
            filter: grayscale(100%) opacity(0.7);
            animation: float 15s infinite linear;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            pointer-events: auto;
            z-index: 6;
        }

        .floating-icon:hover {
            filter: grayscale(0%) opacity(1);
            color: var(--hover-color);
        }

        .floating-icon.apple { animation-duration: 20s; }
        .floating-icon.apple:hover { color: #FF5555; }
        .floating-icon.broccoli { animation-duration: 18s; animation-delay: -5s; }
        .floating-icon.broccoli:hover { color: #FFAA00; }
        .floating-icon.pill { animation-duration: 22s; animation-delay: -10s; }
        .floating-icon.pill:hover { color: #66B3FF; }
        .floating-icon.warning { animation-duration: 19s; animation-delay: -3s; }
        .floating-icon.warning:hover { color: #FF5555; }
        .floating-icon.heartbeat { animation-duration: 21s; animation-delay: -7s; }
        .floating-icon.heartbeat:hover { color: #FF69B4; }
        .floating-icon.lemon { animation-duration: 17s; animation-delay: -2s; }
        .floating-icon.lemon:hover { color: #FFFF00; }
        .floating-icon.utensils { animation-duration: 23s; animation-delay: -8s; }
        .floating-icon.utensils:hover { color: #FFAA00; }
        .floating-icon.shield { animation-duration: 16s; animation-delay: -4s; }
        .floating-icon.shield:hover { color: #0000FF; }

        @keyframes float {
            0% { transform: translate(0, 0); }
            20% { transform: translate(50px, 100px); }
            40% { transform: translate(-30px, 200px); }
            60% { transform: translate(70px, 300px); }
            80% { transform: translate(-50px, 100px); }
            100% { transform: translate(0, 0); }
        }

        /* Navigation Bar */
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--bg-blur);
            z-index: 10;
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }

        .light-mode .navbar {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .navbar.scrolled {
            background: rgba(0, 0, 0, 0.9);
        }

        .light-mode .navbar.scrolled {
            background: rgba(255, 255, 255, 1);
        }

        .nav-links {
            list-style: none;
            display: flex;
            gap: 20px;
            margin: 0;
            padding: 0;
            align-items: center;
        }

        .nav-links li a {
            color: var(--text-color);
            text-decoration: none;
            font-size: 1em;
            font-weight: 190;
            padding: 8px 15px;
            border-radius: 20px;
            transition: color 0.3s ease, background-color 0.3s ease;
        }

        .nav-links li a:hover {
            color: var(--hover-color);
            background-color: rgba(139, 92, 246, 0.1);
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .theme-toggle i {
            font-size: 20px;
            color: var(--primary-color);
            animation: bounce 2s infinite;
        }

        .light-mode .theme-toggle i {
            color: var(--text-color);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .hamburger {
            display: none;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: var(--primary-color);
            transition: transform 0.3s ease;
        }

        .light-mode .hamburger span {
            background: var(--text-color);
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 60px;
                width: 100%;
                background: var(--bg-blur);
                padding: 10px 0;
                backdrop-filter: blur(15px);
                border-bottom: 1px solid var(--border-color);
            }

            .nav-links.show {
                display: flex;
            }

            .nav-links li {
                text-align: center;
                padding: 10px 0;
            }

            .nav-links a {
                width: 100%;
                text-align: center;
                padding: 10px 15px;
            }

            .hamburger {
                display: flex;
                position: absolute;
                right: 20px;
            }

            .theme-toggle {
                margin-right: 60px;
            }
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 80px 20px 20px;
            position: relative;
            z-index: 1;
        }

        .chat-area {
            width: 100%;
            max-width: 800px;
            height: 70vh;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) rgba(255, 255, 255, 0.1);
        }

        .chat-area::-webkit-scrollbar {
            width: 8px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
            box-shadow: 0 0 5px rgba(139, 92, 246, 0.5);
        }

        .chat-message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            animation: bubbleFadeIn 0.5s ease-out;
        }

        .chat-message.user {
            justify-content: flex-end;
        }

        .bot-avatar {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            border-radius: 50%;
            background: url('https://www.flaticon.com/free-icon/cdn_18169195?term=cdn&page=1&position=37&origin=tag&related_id=18169195') center/cover;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(139, 92, 246, 0.8);
            }
            100% {
                box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
            }
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 16px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .message-bubble ul {
            list-style-type: disc;
            margin: 10px 0;
            padding-left: 20px;
        }

        .message-bubble li {
            margin-bottom: 5px;
        }

        .chat-message.user .message-bubble {
            background: var(--primary-color);
            color: #121212;
            border-bottom-right-radius: 5px;
        }

        .chat-message.bot .message-bubble {
            background: rgba(42, 42, 42, 0.7);
            color: var(--text-color);
            border-bottom-left-radius: 5px;
            text-shadow: 0 0 5px var(--primary-color);
        }

        .ingredient-warning {
            background: rgba(255, 0, 0, 0.3);
            color: #FF5555;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 5px 0;
            display: inline-block;
        }

        .loading-bubble {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 15px;
            background: rgba(42, 42, 42, 0.7);
            color: var(--text-color);
            font-size: 16px;
        }

        .loading-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            margin: 0 3px;
            animation: loading 1.2s infinite;
        }

        .loading-dots span:nth-child(2) { animation-delay: 0.4s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.8s; }

        @keyframes loading {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.5; }
            40% { transform: translateY(-5px); opacity: 1; }
        }

        @keyframes bubbleFadeIn {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-area {
            width: 100%;
            max-width: 800px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
        }

        .light-mode .input-area {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        #chatInput {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: #2A2A2A;
            color: var(--text-color);
            font-size: 16px;
            transition: box-shadow 0.3s ease;
        }

        .light-mode #chatInput {
            background: #E0E0E0;
            color: var(--text-color);
        }

        #chatInput:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        .icon-button {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .icon-button img {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 5px var(--primary-color));
        }

        .icon-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.8);
        }

        .stop-button {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stop-button i {
            font-size: 24px;
            color: var(--primary-color);
            filter: drop-shadow(0 0 5px var(--primary-color));
        }

        .stop-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.8);
        }

        .prompt-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .prompt-button {
            padding: 8px 15px;
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .prompt-button:hover {
            background: rgba(139, 92, 246, 0.2);
            box-shadow: 0 0 10px var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Floating Icons -->
    <div class="floating-icons">    
        <i class="fas fa-apple-alt floating-icon apple" style="top: 10%; left: 15%;"></i>
        <i class="fas fa-carrot floating-icon broccoli" style="top: 20%; left: 80%;"></i>
        <i class="fas fa-capsules floating-icon pill" style="top: 70%; left: 30%;"></i>
        <i class="fas fa-exclamation-triangle floating-icon warning" style="top: 50%; left: 60%;"></i>
        <i class="fas fa-heartbeat floating-icon heartbeat" style="top: 30%; left: 40%;"></i>
        <i class="fas fa-apple-alt floating-icon apple" style="top: 80%; left: 70%;"></i>
        <i class="fas fa-carrot floating-icon broccoli" style="top: 40%; left: 10%;"></i>
        <i class="fas fa-capsules floating-icon pill" style="top: 60%; left: 90%;"></i>
        <i class="fas fa-lemon floating-icon lemon" style="top: 15%; left: 50%;"></i>
        <i class="fas fa-utensils floating-icon utensils" style="top: 65%; left: 20%;"></i>
        <i class="fas fa-shield-alt floating-icon shield" style="top: 25%; left: 70%;"></i>
        <i class="fas fa-lemon floating-icon lemon" style="top: 75%; left: 40%;"></i>
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <ul class="nav-links">
            <li><a href="/">Home</a></li>
            <li><a href="/static/tellusaboutyou.html">Personalise</a></li>
            <li><a href="/static/askme.html">Chat</a></li>
            <li><a href="/static/calorietracker.html">Track Your Calories</a></li>
            <li><a href="/static/foodsafety.html">Food Safety</a></li>
            <li class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon"></i>
            </li>
        </ul>
        <div class="hamburger" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <div class="chat-container">
        <div id="chatArea" class="chat-area"></div>
        <div class="input-area">
            <input type="text" id="chatInput" placeholder="Ask about food safety..." onkeypress="if(event.key === 'Enter') sendMessage()">
            <button id="sendButton" class="icon-button" onclick="sendMessage()">
                <img src="https://cdn-icons-png.flaticon.com/512/876/876777.png" alt="Send Message">
            </button>
            <button id="stopButton" class="stop-button" onclick="stopTyping()" style="display: none;">
                <i class="fas fa-stop"></i>
            </button>
            <button class="icon-button" onclick="document.getElementById('imageInput').click()">
                <img src="https://cdn-icons-png.flaticon.com/512/3097/3097412.png" alt="Upload Image">
            </button>
            <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
        </div>
        <div class="prompt-buttons">
            <button class="prompt-button" onclick="sendPrompt('Is this safe for me to eat?')">Is this safe for me to eat?</button>
            <button class="prompt-button" onclick="sendPrompt('What are the ingredients in this food?')">What are the ingredients in this food?</button>
            <button class="prompt-button" onclick="sendPrompt('Can you suggest a meal plan?')">Can you suggest a meal plan?</button>
        </div>
    </div>

    <script>
        let messages = [
            {
                role: "assistant",
                content: "Hey, how can I help you today?",
                typed: true
            }
        ];

        let currentController = null;
        let typingAnimationFrame = null;
        let isTyping = false;

        window.onload = function() {
            displayMessages();
        };

        function toggleMenu() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('show');
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const themeIcon = document.querySelector('.theme-toggle i');
            if (document.body.classList.contains('light-mode')) {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }

        function formatMessageContent(content) {
            let formatted = content.replace(/\n/g, '<br>');
            const listRegex = /^(?:[*-]\s.*(?:\n[*-]\s.*)*)$/gm;
            const listItems = formatted.match(listRegex);
            if (listItems) {
                listItems.forEach(list => {
                    const items = list.split('\n').map(item => {
                        const text = item.replace(/^[*-]\s/, '');
                        return `<li>${text}</li>`;
                    }).join('');
                    const ul = `<ul>${items}</ul>`;
                    formatted = formatted.replace(list, ul);
                });
            }
            return formatted;
        }

        function displayMessages() {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '';

            messages.forEach((msg, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.role === 'user' ? 'user' : 'bot'}`;

                if (msg.role === 'assistant') {
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'bot-avatar';
                    messageDiv.appendChild(avatarDiv);
                }

                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble';
                messageDiv.appendChild(bubbleDiv);

                if (msg.role === 'assistant' && !msg.isImage && !msg.typed) {
                    typeWriterEffect(bubbleDiv, msg.content, 20, true);
                    messages[index].typed = true;
                } else if (msg.role === 'assistant' && !msg.isImage) {
                    bubbleDiv.innerHTML = formatMessageContent(msg.content);
                } else {
                    bubbleDiv.textContent = msg.content;
                }

                if (msg.isImage) {
                    const img = document.createElement('img');
                    img.src = msg.imageSrc;
                    img.style.maxWidth = '200px';
                    img.style.borderRadius = '10px';
                    img.style.marginTop = '10px';
                    messageDiv.appendChild(img);

                    if (msg.ingredientAnalysis) {
                        const analysisDiv = document.createElement('div');
                        analysisDiv.className = 'message-bubble';
                        analysisDiv.style.marginTop = '10px';
                        if (!msg.typedAnalysis) {
                            typeWriterEffect(analysisDiv, msg.ingredientAnalysis, 20, true);
                            messages[index].typedAnalysis = true;
                        } else {
                            analysisDiv.innerHTML = formatMessageContent(msg.ingredientAnalysis);
                        }

                        const harmfulItems = extractHarmfulItems(msg.ingredientAnalysis);
                        if (harmfulItems.length > 0) {
                            const warningDiv = document.createElement('div');
                            warningDiv.className = 'ingredient-warning';
                            warningDiv.textContent = `Warning: Harmful Ingredients - ${harmfulItems.join(', ')}`;
                            messageDiv.appendChild(warningDiv);
                        }

                        messageDiv.appendChild(analysisDiv);
                    }
                }

                chatArea.appendChild(messageDiv);
            });

            chatArea.scrollTo({
                top: chatArea.scrollHeight,
                behavior: 'smooth'
            });
        }

        function showLoadingMessage() {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message bot';
            messageDiv.id = 'loadingMessage';

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'bot-avatar';
            messageDiv.appendChild(avatarDiv);

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'loading-bubble';
            bubbleDiv.innerHTML = `Analyzing <span class="loading-dots"><span></span><span></span><span></span></span>`;
            messageDiv.appendChild(bubbleDiv);

            chatArea.appendChild(messageDiv);
            chatArea.scrollTo({
                top: chatArea.scrollHeight,
                behavior: 'smooth'
            });
        }

        function removeLoadingMessage() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        function extractHarmfulItems(analysis) {
            const harmfulKeywords = ['unsafe', 'allergic', 'risk', 'avoid', 'dangerous'];
            const words = analysis.toLowerCase().split(/\s+/);
            return words.filter(word => harmfulKeywords.some(keyword => word.includes(keyword)));
        }

        function typeWriterEffect(element, text, speed, format = false) {
            let i = 0;
            element.innerHTML = '';
            const formattedText = format ? formatMessageContent(text) : text;
            isTyping = true;
            toggleButtons(true);

            function type() {
                if (i < formattedText.length && isTyping) {
                    element.innerHTML = formattedText.substring(0, i + 1);
                    i++;
                    typingAnimationFrame = requestAnimationFrame(type);
                } else {
                    isTyping = false;
                    toggleButtons(false);
                }
            }
            type();
        }

        function stopTyping() {
            isTyping = false;
            if (typingAnimationFrame) {
                cancelAnimationFrame(typingAnimationFrame);
            }
            toggleButtons(false);
        }

        function toggleButtons(showStop) {
            const sendButton = document.getElementById('sendButton');
            const stopButton = document.getElementById('stopButton');
            if (showStop) {
                sendButton.style.display = 'none';
                stopButton.style.display = 'flex';
            } else {
                sendButton.style.display = 'block';
                stopButton.style.display = 'none';
            }
        }

        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (!message) return;

            if (currentController) {
                currentController.abort();
            }

            currentController = new AbortController();
            const signal = currentController.signal;

            messages.push({ role: 'user', content: message });
            chatInput.value = '';
            displayMessages();
            showLoadingMessage();

            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message }),
                signal
            })
            .then(response => response.json())
            .then(data => {
                removeLoadingMessage();
                if (data.success) {
                    messages.push({ role: 'assistant', content: data.reply });
                    displayMessages();
                } else {
                    messages.push({ role: 'assistant', content: 'Error: Could not process your request.' });
                    displayMessages();
                }
                currentController = null;
            })
            .catch(error => {
                removeLoadingMessage();
                if (error.name === 'AbortError') {
                    console.log('Previous request aborted');
                } else {
                    console.error('Error:', error);
                    messages.push({ role: 'assistant', content: 'Error: Could not connect to the server.' });
                    displayMessages();
                }
                currentController = null;
            });
        }

        function sendPrompt(prompt) {
            document.getElementById('chatInput').value = prompt;
            sendMessage();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageSrc = e.target.result;

                messages.push({
                    role: 'user',
                    isImage: true,
                    imageSrc: imageSrc
                });
                displayMessages();
                showLoadingMessage();

                if (currentController) {
                    currentController.abort();
                }

                currentController = new AbortController();
                const signal = currentController.signal;

                fetch('/saveImage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageSrc: imageSrc,
                        personalDetails: window.personalDetails || ''
                    }),
                    signal
                })
                .then(response => response.json())
                .then(data => {
                    removeLoadingMessage();
                    if (data.success) {
                        const extractedText = data.extracted_text || 'No text extracted from image.';
                        messages.push({
                            role: 'assistant',
                            content: `Extracted Ingredients: ${extractedText}`,
                            isImage: true,
                            imageSrc: imageSrc
                        });

                        showLoadingMessage();
                        fetch('/ingredients', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ ingredients: extractedText }),
                            signal
                        })
                        .then(response => response.json())
                        .then(data => {
                            removeLoadingMessage();
                            if (data.success) {
                                const ingredientAnalysis = data.ingredient_analysis || 'No analysis available.';
                                messages[messages.length - 1].ingredientAnalysis = ingredientAnalysis;
                            } else {
                                messages[messages.length - 1].ingredientAnalysis = 'Error: Could not analyze ingredients.';
                            }
                            displayMessages();
                        })
                        .catch(error => {
                            removeLoadingMessage();
                            if (error.name === 'AbortError') {
                                console.log('Previous request aborted');
                            } else {
                                console.error('Error:', error);
                                messages[messages.length - 1].ingredientAnalysis = 'Error: Could not connect to the server.';
                                displayMessages();
                            }
                            currentController = null;
                        });
                    } else {
                        messages.push({
                            role: 'assistant',
                            content: 'Error: Could not process the image.'
                        });
                        displayMessages();
                    }
                    currentController = null;
                })
                .catch(error => {
                    removeLoadingMessage();
                    if (error.name === 'AbortError') {
                        console.log('Previous request aborted');
                    } else {
                        console.error('Error:', error);
                        messages.push({
                            role: 'assistant',
                            content: 'Error: Could not connect to the server.'
                        });
                        displayMessages();
                    }
                    currentController = null;
                });
            };
            reader.readAsDataURL(file);
        }

        // Navbar Scroll Effect
        window.addEventListener('scroll', () => {
            const navbar = document.querySelector('.navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });

        // Floating Icons Debug
        const icons = document.querySelectorAll('.floating-icon');
        icons.forEach(icon => {
            icon.addEventListener('mouseenter', () => {
                console.log(`Hover started on ${icon.className}`);
                icon.classList.add('hovered');
            });
            icon.addEventListener('mouseleave', () => {
                console.log(`Hover ended on ${icon.className}`);
                icon.classList.remove('hovered');
            });
        });
    </script>
</body>
</html>